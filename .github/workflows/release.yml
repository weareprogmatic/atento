name: Release Workflow

on:
  push:
    branches: [main,test-release]

env:
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      # ------------------------------
      # 1. Checkout & Setup Rust
      # ------------------------------
      - uses: actions/checkout@v3

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: Cache cargo registry and git
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo binaries
        uses: actions/cache@v3
        with:
          path: ~/.cargo/bin
          key: ${{ runner.os }}-cargo-bin

      - name: Install tools
        run: |
          cargo install cargo-edit --force
          cargo install cross --force

      # ------------------------------
      # 2. Determine version bump
      # ------------------------------
      - name: Determine bump type
        id: bump_version
        run: |
          VERSION=$(cargo pkgid | sed 's/.*#//; s/^v//')
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
          MAJOR=${MAJOR:-0}
          MINOR=${MINOR:-0}
          PATCH=${PATCH:-0}
          BUMP_TYPE="patch"
          PR_NUMBER=$(gh pr list --state merged --base main -L1 --json number --jq '.[0].number')
          LABELS=$(gh pr view $PR_NUMBER --json labels --jq '.labels[].name' || echo "")
          if echo "$LABELS" | grep -iq "major"; then
            BUMP_TYPE="major"
          elif echo "$LABELS" | grep -iq "minor"; then
            BUMP_TYPE="minor"
          fi
          case $BUMP_TYPE in
            patch) PATCH=$((PATCH + 1));;
            minor) MINOR=$((MINOR + 1)); PATCH=0;;
            major) MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0;;
          esac
          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV

      - name: Bump versions
        run: |
          cargo set-version $NEW_VERSION --manifest-path atento-core/Cargo.toml
          cargo set-version $NEW_VERSION --manifest-path atento-cli/Cargo.toml

      - name: Commit & push version bump
        if: github.ref == 'refs/heads/main'
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add atento-core/Cargo.toml atento-cli/Cargo.toml
          git commit -m "Bump version to $NEW_VERSION [skip ci]" || echo "No changes"
          git tag v$NEW_VERSION
          git push origin main --tags

      # ------------------------------
      # 3. Publish crate
      # ------------------------------
      - name: Publish core to crates.io
        run: cargo publish --manifest-path atento-core/Cargo.toml --token ${{ secrets.CARGO_TOKEN }}

  build-linux-windows:
    needs: release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
      - run: cargo install cross --force
      # Linux builds
      - run: cross build --release --target x86_64-unknown-linux-musl --bin atento-cli --target-dir target/x86_64-unknown-linux-musl
      - run: cross build --release --target aarch64-unknown-linux-musl --bin atento-cli --target-dir target/aarch64-unknown-linux-musl
      # Windows builds
      - run: cross build --release --target x86_64-pc-windows-gnu --bin atento-cli --target-dir target/x86_64-pc-windows-gnu
      - run: cross build --release --target aarch64-pc-windows-gnu --bin atento-cli --target-dir target/aarch64-pc-windows-gnu
      # Rename binaries
      - run: |
          for dir in target/*/*/release; do
            for file in $dir/atento-cli*; do
              mv "$file" "${file/atento-cli/atento}"
            done
          done

  build-macos:
    needs: release
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
      - run: cargo build --release --target aarch64-apple-darwin --bin atento-cli --target-dir target/aarch64-apple-darwin
      - run: |
          for file in target/aarch64-apple-darwin/release/atento-cli*; do
            mv "$file" "${file/atento-cli/atento}"
          done

  create-release:
    needs: [build-linux-windows, build-macos]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.NEW_VERSION }}
          name: "Release v${{ env.NEW_VERSION }}"
      - uses: softprops/action-gh-release@v1
        with:
          files: target/*/*/release/atento*
